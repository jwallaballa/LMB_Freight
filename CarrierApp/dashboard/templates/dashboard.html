{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard | LMB Freight{% endblock %}

{% block content %}
    <div class="notification" id="notification"></div>

    <div class="stats">
        <div class="card">
            <h3>Total Orders</h3>
            <p>{{ total_orders }}</p>
        </div>
        <div class="card">
            <h3>Open POs</h3>
            <p>{{ pending_shipments }}</p>
        </div>
        <div class="card">
            <h3>Unassigned</h3>
             <p>{{ unassigned }}</p>
        </div>
    </div>

    <div class="controls">
        <a href="{% url 'add_order' %}">Create order</a>
        <input type="text" id="search" placeholder="Search orders...">
        <select id="rows-per-page">
            <option value="25">25 rows</option>
            <option value="50">50 rows</option>
            <option value="100">100 rows</option>
        </select>
    </div>

    <table>
        <thead>
            <tr>
                <th>Customer Name</th>
                <th>PO Number</th>
                <th>Ship Date</th>
                <th>Order Number</th>
                <th>From</th>
                <th>Carrier</th>
                <th>Cost</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody id="orders-tbody">
            {% for order in orders %}
            <tr data-id="{{ order.id }}">
                <td contenteditable="true" data-field="customer_name">{{ order.customer_name }}</td>
                <td contenteditable="true" data-field="po_number">{{ order.po_number }}</td>
                <td contenteditable="true" data-field="ship_date">{{ order.ship_date|date:"Y-m-d" }}</td>
                <td contenteditable="true" data-field="order_number">{{ order.order_number }}</td>
                <td contenteditable="true" data-field="location_from">{{ order.location_from }}</td>
                <td contenteditable="true" data-field="carrier">{{ order.carrier }}</td>
                <td contenteditable="true" data-field="cost">{{ order.cost }}</td>
                <td>
                    <select class="status-select" data-id="{{ order.id }}">
                        <option value="open" {% if order.status == 'open' %}selected{% endif %}>Open</option>
                        <option value="closed" {% if order.status == 'closed' %}selected{% endif %}>Closed</option>
                    </select>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="chart-container">
        <h3>Orders by Month</h3>
        <canvas id="ordersChart" width="400" height="150"></canvas>
    </div>


{% endblock %}

{% block scripts %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const table = document.querySelector('table');
            const notification = document.getElementById('notification');

            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let c of cookies) {
                        const cookie = c.trim();
                        if (cookie.startsWith(name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            function showNotification(message, type='success') {
                notification.textContent = message;
                notification.style.backgroundColor = type==='error' ? '#f44336' : '#4CAF50';
                notification.classList.add('show');
                setTimeout(()=>notification.classList.remove('show'), 3000);
            }

            // Editable table cells
            table.addEventListener('blur', (event) => {
                const cell = event.target;
                if (cell.tagName === 'TD' && cell.hasAttribute('contenteditable')) {
                    const row = cell.closest('tr');
                    const orderId = row.dataset.id;
                    const fieldName = cell.dataset.field;
                    const newValue = cell.textContent;

                    fetch('/dashboard/update-order/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({ id: orderId, field: fieldName, value: newValue })
                    })
                    .then(res => res.json())
                    .then(result => {
                        if (result.status === 'success') showNotification('Order updated successfully!');
                        else showNotification('Error: ' + result.message, 'error');
                    })
                    .catch(err => showNotification('Network error: ' + err, 'error'));
                }
            }, true);

            // Status dropdown update
            document.querySelectorAll('.status-select').forEach(select => {
                select.addEventListener('change', (event) => {
                    const newStatus = event.target.value;
                    const orderId = event.target.dataset.id;

                    fetch('/dashboard/update-order/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({ id: orderId, field: 'status', value: newStatus })
                    })
                    .then(res => res.json())
                    .then(result => {
                        if (result.status === 'success') showNotification('Order status updated!');
                        else showNotification('Error: ' + result.message, 'error');
                    })
                    .catch(err => showNotification('Network error: ' + err, 'error'));
                });
            });

            // Table search
            document.getElementById('search').addEventListener('input', e => {
                const filter = e.target.value.toLowerCase();
                document.querySelectorAll('#orders-tbody tr').forEach(tr => {
                    tr.style.display = [...tr.children].some(td => td.textContent.toLowerCase().includes(filter)) ? '' : 'none';
                });
            });

            // Rows-per-page filter
            document.getElementById('rows-per-page').addEventListener('change', e => {
                const maxRows = parseInt(e.target.value);
                const rows = document.querySelectorAll('#orders-tbody tr');
                rows.forEach((tr, idx) => {
                    tr.style.display = idx < maxRows ? '' : 'none';
                });
            });

            // Existing bar chart
            const ctxBar = document.getElementById('ordersChart').getContext('2d');
            new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr'],
                    datasets: [{
                        label: 'Orders',
                        data: [12, 19, 3, 5],
                        backgroundColor: '#49a942'
                    }]
                },
                options: {
                    responsive: true,
                }
            });
        });
    </script>
{% endblock %}